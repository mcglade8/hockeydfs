---
title: "HockeyDFS.rmd"
output: html_document
date: "2022-12-19"
---


### Setup
```{r setup, include= FALSE}
library(lpSolve)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(coach)
library(googlesheets4)
library(R.utils)
library(tm)


```



### My optimizer
```{r lpSolve-opto}
# Parameters
 
# stacks may need to be full info from all_lines for creating the vectors

  num_lineups <- 100
  stack1size <- 4
  stack2size <- 3
  testing <- F
  variance <- 15 # increase here increases lineup diversity with regards to stack selection
  darts <- 0.01 # ownership cutoff for dart throw players; lower for big slates
  
  timeout_threshhold <- 0.8
  
  
if(!testing){
data <- read_dk("C:/Users/jorda/Downloads/DKSalariesNHL.csv")
projections <- read_sheet("https://docs.google.com/spreadsheets/d/1ktMclwMSxcjW3WIHOdMhnNpzWcmO6gPqKdtLaAHN2nQ/edit#gid=1735928548")


  # Building dataframe


  
  data <- select(data, player_id, player, salary, opp_team)
  projections <- select(projections, Name, DK.Implied.FPs, Position, Team, Line, PP.Line.1, DKOwnProj) %>%
    rename(player = Name, fpts_proj = DK.Implied.FPs) 
  
   data <- merge(data, projections)
   teams <- data$Team %>%
    unique()

   odata <- data
}
  
timeouts <- 0
rm(lineups)
t <- 0
while(t < num_lineups){
  timeouts <- timeouts+1
  
  # tryCatch(
  # expr = {
  #   withTimeout({
  
  data <- odata %>%
    filter(!(player == "Sebastian Aho" & salary <= 3500)) %>%
    distinct()
    
      first_line <- data %>%
      filter(Line == 1) %>%
      group_by(Team) %>%
      summarise(line_proj = sum(fpts_proj), cost = sum(salary)) %>%
      mutate(stack = gsub(" ", "", paste(Team, "1")))
      second_line <- data %>%
      filter(Line == 2) %>%
      group_by(Team) %>%
      summarise(line_proj = sum(fpts_proj), cost = sum(salary)) %>%
      mutate(stack = gsub(" ", "", paste(Team, "2")))
      third_line <- data %>%
      filter(Line == 3) %>%
      group_by(Team) %>%
      summarise(line_proj = sum(fpts_proj), cost = sum(salary)) %>%
      mutate(stack = gsub(" ", "", paste(Team, "3")))
      fourth_line <- data %>%
      filter(Line == 4) %>%
      group_by(Team) %>%
      summarise(line_proj = sum(fpts_proj), cost = sum(salary)) %>%
      mutate(stack = gsub(" ", "", paste(Team, "4")))
      pp_line <- data %>%
      filter(PP.Line.1 == TRUE) %>%
      group_by(Team) %>%
      summarise(line_proj = sum(fpts_proj)/2, cost = sum(salary)) %>%
      mutate(stack = gsub(" ", "", paste(Team, "PP")))
      
      all_lines <- rbind(first_line, second_line, third_line, fourth_line, pp_line)
      all_lines$select <- runif(length(all_lines$Team), 0, all_lines$line_proj+variance)
      all_lines <- all_lines %>%
        group_by(Team) %>%
        slice_max(select)
      
      all_lines <- all_lines[order(all_lines$select, decreasing = T),]
      
      stacks <- all_lines %>%
        ungroup() %>%
        slice_max(order_by = select, n = 2)
    
      data<- data %>%
        mutate(stackline = case_when(
          gsub(" ", "", paste0(Team, Line)) == stacks$stack[1] ~ "stack1",
          gsub(" ", "", paste0(Team, Line)) == stacks$stack[2] ~ "stack2",
          Position %in% c("G") & opp_team %in% stacks$stack ~ "opp_g",
          Position %in% c("G") ~ "G",
          Team %in% stacks$Team ~ "ignore",
          T ~ "unstacked"
        ))

  
### my optimizer


  
## Objective

objective.in <- rnorm(length(data$fpts_proj), data$fpts_proj, sd = 2+data$fpts_proj/4)

## Constraint matrix - salary, is in a stack, position, util


vsalary <- data$salary
vcenter <- as.numeric(data$Position == "C")
vwing <- as.numeric(data$Position == "W")
vdef <- as.numeric(data$Position == "D")
vgoal <- as.numeric(data$Position == "G")
vutil <- as.numeric(!vgoal)
vplaying <- as.numeric(data$fpts_proj > 0)
vdarts <- data$DKOwnProj < darts & !data$stackline  == "stackF"
vstack1 <- as.numeric(data$stackline == "stack1")
vstack2 <- as.numeric(data$stackline == "stack2")
voneoff <- as.numeric(data$stackline == "unstacked")
voppg <- as.numeric(data$stackline == "opp_g")

matrix_vector <- c(vsalary, vcenter, vwing, vdef, vgoal, vutil, vplaying,  vdarts, vstack1,vstack2,  voneoff, voppg)

  
matrix_vector[is.na(matrix_vector)] <- 0
matrix_vector[is.infinite(matrix_vector)] <- 0

const.mat = matrix(matrix_vector, nrow = length(matrix_vector)/length(data$salary), byrow = TRUE)

## Define constraints and direction - 50000 salary
const.rhs = c(50000,  2,  3,  2,   1,    8,    9, 1, stack1size, stack2size, 1, 0)
const.dir = c("<=", ">=",">=",">=", "==", "==", "==",  "<=", "==","==", ">=", "==")




### Optimize
objective.in[is.nan(objective.in)] <- 0
objective.in[objective.in < 0] <- 0
optimum = lp(direction = "max", objective.in, const.mat, const.dir, const.rhs, all.bin = TRUE)

#rm(lineup)
data$optimal <- optimum$solution
if(sum(data$optimal)>0){
lineup <- filter(data, optimal == 1) %>% select(player_id, Position)
lc <- filter(lineup, Position == "C") %>% select(-Position)
lw <-  filter(lineup, Position == "W") %>% select(-Position)
ld <-  filter(lineup, Position == "D") %>% select(-Position)
lg <-  filter(lineup, Position == "G") %>% select(-Position)
u <- case_when(length(lc$player_id)>2 ~ lc$player_id[3], length(lw$player_id)>3 ~ lw$player_id[4], length(ld$player_id)>2 ~ ld$player_id[3])
lc<- filter(lc, !player_id == u)
lw<- filter(lw, !player_id == u)
ld<- filter(ld, !player_id == u)
lineup <- c(lc$player_id, lw$player_id, ld$player_id, lg$player_id, u)


if(t > 0){
 
  lineups <- cbind(lineups, lineup)

} else{

  lineups <- as.data.frame(lineup)

}
lineups <- lineups %>% unique()
 t <- ncol(lineups)
}
    
# }, timeout = timeout_threshhold)
#   }, TimeoutException = function(ex) { 
#     #cat("\nTimeout. Lineups built so far: ", n-1, "/", num_lineups," \n")
#     
# })
  

    
}


ownership <- data %>%
  select(player, player_id)
ownership$ownership_pct <- 0

for(i in 1:length(ownership$player)){
  ownership$ownership_pct[i] = sum(lineups == ownership$player_id[i])
}
ownership$ownership_pct <- ownership$ownership_pct/ length(lineups[,1])*100
ownership <- ownership[order(ownership$ownership_pct, decreasing = TRUE),]

cat("\nBuild fails: ", timeouts-t)

lineups <- t(lineups)
colnames(lineups) <- c("C", "C", "W", "W", "W", "D", "D", "G", "UTIL")

write.csv(lineups, "C:/Users/jorda/Downloads/DKLineupsNHL.csv", row.names = FALSE)
```


### Lineup Editor
```{r lineup-editor}

### Build lineups above, then use this to edit entries for direct upload

plineups <- read.csv("C:/Users/jorda/Downloads/DKEntriesNHL.csv")

plineups <- filter(plineups, !is.na(Entry.ID) & !is.na(as.numeric(Entry.ID))) %>%
  select(Entry.ID, Contest.Name, Contest.ID, Entry.Fee)

newlineups <- read.csv("C:/Users/jorda/Downloads/DKLineupsNHL.csv")

newlineups <- cbind(plineups, newlineups)
colnames(newlineups) <- c("Entry ID", "Contest Name", "Contest ID", "Entry Fee", "C", "C", "W", "W", "W", "D", "D", "G", "UTIL")

write.csv(newlineups, "C:/Users/jorda/Downloads/DKEntriesNHL.csv", row.names = FALSE)

```


### Game Analysis
```{r game-analysis}

sheet_data <- read_sheet("https://docs.google.com/spreadsheets/d/1ktMclwMSxcjW3WIHOdMhnNpzWcmO6gPqKdtLaAHN2nQ/edit#gid=1735928548")

#x <- sheet_data[complete.cases(sheet_data),]
x <- filter(sheet_data, DKOwnProj > 0 & Position == "G" & DK.Implied.FPs > 0 & DK.Implied.FPs != 10)

fp_model <- lm(DK.Implied.FPs ~ `DK Salary` + DKOwnProj, data = x)
summary(fp_model)
```


